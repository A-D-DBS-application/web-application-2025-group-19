{% extends 'base.html' %}
{% block title %}Nieuwe Levering — Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Nieuwe Levering Plannen</h1>
  <p class="page-subtitle">Plan een nieuwe levering door het formulier in te vullen.</p>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
  <!-- Formulier -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="font-semibold">Leveringsgegevens</h2>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('main.schedule') }}" id="delivery-form">
          <!-- Hidden fields -->
          <input type="hidden" name="lat" id="lat-input" value="">
          <input type="hidden" name="lng" id="lng-input" value="">
          <input type="hidden" name="selected_region_id" id="selected-region-id" value="">
          <input type="hidden" name="region_id" id="region-input" value="">

          <div class="form-group">
            <label class="form-label">Adres</label>
            <input type="text" name="address" id="delivery-address" placeholder="Kerkstraat 10, 1000 Brussel" class="form-input" required>
            <div id="geocode-status" class="mt-2 hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Leveringsdatum</label>
            <input type="date" name="scheduled_date" id="scheduled-date" class="form-input" required>
            <div id="location-suggestions" class="mt-3 hidden">
              <p class="text-small font-medium mb-2" style="color: var(--color-dark-gray);">Voorgestelde datums in deze regio:</p>
              <div id="suggestion-cards" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            </div>
            <div id="no-suggestions" class="mt-3 hidden">
              <p class="text-small text-muted">Dit adres valt niet binnen een bestaande regio. Er wordt een nieuwe regio aangemaakt.</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Product ID</label>
            <input type="number" name="order_id" placeholder="12345" class="form-input" required>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Levering Plannen</button>
        </form>
      </div>
    </div>

    <!-- Regio Info -->
    <div id="region-info" class="card hidden">
      <div class="card-header">
        <h3 class="font-semibold">Geselecteerde Regio</h3>
      </div>
      <div class="card-body" id="region-details"></div>
    </div>
  </div>

  <!-- Zijbalk -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Hoe het werkt</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">1</div>
            <p class="text-small">Voer het volledige leveradres in</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">2</div>
            <p class="text-small">Het systeem zoekt automatisch regio's binnen 30km</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">3</div>
            <p class="text-small">Datums met minder dan 13 leveringen worden voorgesteld</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">4</div>
            <p class="text-small">Kies een datum en het adres wordt toegevoegd</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="font-semibold">Regio Regels</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Straal:</strong> 30 km vanaf centrum</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Max leveringen:</strong> 13 per dag per regio</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Centrum:</strong> Wordt herberekend per nieuw adres</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentLat = null;
  let currentLng = null;
  let currentSuggestions = [];
  let geocodeTimeout = null;

  document.addEventListener('DOMContentLoaded', function() {
    initAddressGeocoding();
  });

  function initAddressGeocoding() {
    const addressInput = document.getElementById('delivery-address');
    if (!addressInput) return;

    addressInput.addEventListener('input', function() {
      const address = this.value.trim();
      clearTimeout(geocodeTimeout);
      
      if (address.length >= 5) {
        geocodeTimeout = setTimeout(() => geocodeAddress(address), 800);
      } else {
        hideGeocodeStatus();
        hideSuggestions();
      }
    });
  }

  function geocodeAddress(address) {
    showGeocodeStatus('loading', 'Adres zoeken...');
    
    fetch(`/api/geocode?address=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showGeocodeStatus('error', data.error);
          hideSuggestions();
          return;
        }
        
        currentLat = data.lat;
        currentLng = data.lng;
        document.getElementById('lat-input').value = data.lat;
        document.getElementById('lng-input').value = data.lng;
        
        showGeocodeStatus('success', 'Gevonden: ' + data.formatted_address);
        loadLocationSuggestions(data.lat, data.lng);
      })
      .catch(error => {
        showGeocodeStatus('error', 'Kon adres niet vinden');
        hideSuggestions();
      });
  }

  function showGeocodeStatus(type, message) {
    const statusDiv = document.getElementById('geocode-status');
    const colors = {
      loading: { bg: 'rgba(65, 90, 119, 0.1)', color: 'var(--color-stone-blue)' },
      success: { bg: 'rgba(46, 125, 74, 0.1)', color: 'var(--color-success)' },
      error: { bg: 'rgba(155, 44, 44, 0.1)', color: 'var(--color-error)' }
    };
    statusDiv.style.background = colors[type].bg;
    statusDiv.style.color = colors[type].color;
    statusDiv.style.padding = '0.5rem 0.75rem';
    statusDiv.style.borderRadius = '6px';
    statusDiv.style.fontSize = '0.875rem';
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
  }

  function hideGeocodeStatus() {
    document.getElementById('geocode-status').classList.add('hidden');
  }

  function loadLocationSuggestions(lat, lng) {
    fetch(`/api/suggest-dates-by-location?lat=${lat}&lng=${lng}`)
      .then(response => response.json())
      .then(data => {
        currentSuggestions = data.suggestions || [];
        if (currentSuggestions.length > 0) {
          showSuggestions(currentSuggestions);
        } else {
          showNoSuggestions();
        }
      })
      .catch(() => hideSuggestions());
  }

  function showSuggestions(suggestions) {
    const container = document.getElementById('location-suggestions');
    const cardsDiv = document.getElementById('suggestion-cards');
    document.getElementById('no-suggestions').classList.add('hidden');
    container.classList.remove('hidden');
    
    let html = '';
    suggestions.slice(0, 8).forEach((s, index) => {
      const capacityPercent = Math.round((s.delivery_count / 13) * 100);
      html += `
        <div onclick="selectSuggestion(${index})" style="padding: 0.75rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; cursor: pointer; transition: all 0.15s;" 
             onmouseover="this.style.borderColor='var(--color-navy)'; this.style.background='rgba(27,38,59,0.04)';"
             onmouseout="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.background='transparent';"
             data-index="${index}">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="font-medium">${formatDate(s.date)}</span>
            <span class="badge ${s.spots_left <= 3 ? 'badge-warning' : 'badge-success'}">${s.spots_left} plekken vrij</span>
          </div>
          <div class="text-xs text-muted mt-1">${s.region_name} · ${s.distance_km} km · ${s.delivery_count}/13 leveringen</div>
        </div>
      `;
    });
    cardsDiv.innerHTML = html;
  }

  function showNoSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.remove('hidden');
    document.getElementById('selected-region-id').value = '';
  }

  function hideSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.add('hidden');
  }

  function selectSuggestion(index) {
    const s = currentSuggestions[index];
    if (!s) return;
    
    document.getElementById('scheduled-date').value = s.date;
    document.getElementById('selected-region-id').value = s.region_id;
    document.getElementById('region-input').value = s.region_name;
    
    // Show region info
    const infoDiv = document.getElementById('region-info');
    const detailsDiv = document.getElementById('region-details');
    detailsDiv.innerHTML = `
      <div class="grid grid-cols-2 gap-3">
        <div><p class="text-xs text-muted">Regio</p><p class="font-medium">${s.region_name}</p></div>
        <div><p class="text-xs text-muted">Afstand</p><p class="font-medium">${s.distance_km} km</p></div>
        <div><p class="text-xs text-muted">Leveringen</p><p class="font-medium">${s.delivery_count} van 13</p></div>
        <div><p class="text-xs text-muted">Datum</p><p class="font-medium">${formatDate(s.date)}</p></div>
      </div>
    `;
    infoDiv.classList.remove('hidden');
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('nl-BE', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }
</script>
{% endblock %}
