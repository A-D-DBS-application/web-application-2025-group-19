{% extends 'base.html' %}
{% block title %}Nieuwe Levering — Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Nieuwe Levering Plannen</h1>
  <p class="page-subtitle">Plan een nieuwe levering door het formulier in te vullen.</p>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
  <!-- Formulier -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="font-semibold">Leveringsgegevens</h2>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('main.schedule') }}" id="delivery-form">
          <!-- Hidden fields -->
          <input type="hidden" name="lat" id="lat-input" value="">
          <input type="hidden" name="lng" id="lng-input" value="">
          <input type="hidden" name="selected_region_id" id="selected-region-id" value="">
          <input type="hidden" name="region_id" id="region-input" value="">

          <div class="form-group">
            <label class="form-label">Adres</label>
            <input type="text" name="address" id="delivery-address" placeholder="Kerkstraat 10, 1000 Brussel" class="form-input" required>
            <div id="geocode-status" class="mt-2 hidden"></div>
          </div>

          <!-- Kalender Overzicht - 2 Maanden -->
          <div class="form-group" id="calendar-section">
            <label class="form-label">Leveringskalender</label>
            <div class="card">
              <div class="card-body">
                <!-- Legenda -->
                <div class="flex flex-wrap gap-4 mb-4 text-xs">
                  <div class="flex items-center gap-2">
                    <span style="width: 14px; height: 14px; border-radius: 4px; background: #10B981;"></span>
                    <span>Beschikbaar (chauffeur + truck)</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span style="font-size: 1rem;">⭐</span>
                    <span>Levering(en) in deze regio</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span style="width: 14px; height: 14px; border-radius: 4px; background: #EF4444;"></span>
                    <span>Vol / Geblokkeerd</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span style="width: 14px; height: 14px; border-radius: 4px; background: rgba(0,0,0,0.1);"></span>
                    <span>Verleden</span>
                  </div>
                </div>
                
                <!-- Twee Maanden Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                  <!-- Maand 1 -->
                  <div>
                    <h4 id="month1-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
                    <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
                    </div>
                    <div id="month1-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
                  </div>
                  
                  <!-- Maand 2 -->
                  <div>
                    <h4 id="month2-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
                    <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
                      <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
                    </div>
                    <div id="month2-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
                  </div>
                </div>
                
                <p id="calendar-hint" class="text-xs text-muted mt-4" style="text-align: center;">
                  Klik op een groene dag om deze te selecteren als leveringsdatum. 
                  <span id="address-hint" style="display: none;">Sterren ⭐ verschijnen bij dagen met bestaande leveringen in dezelfde regio.</span>
                </p>
              </div>
            </div>
            <input type="hidden" name="scheduled_date" id="scheduled-date" required>
            <div id="no-suggestions" class="mt-3 hidden">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Product beschrijving</label>
            <input type="text" name="product_description" placeholder="Omschrijf product" class="form-input" required>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Levering Plannen</button>
</form>
      </div>
    </div>


    <!-- Regio Info -->
    <div id="region-info" class="card hidden">
      <div class="card-header">
        <h3 class="font-semibold">Leveringsgegevens</h3>
      </div>
      <div class="card-body" id="region-details"></div>
    </div>
  </div>

  <!-- Zijbalk -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Regio Regels</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Straal:</strong> 30 km vanaf centrum</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Max leveringen:</strong> 13 per dag per regio</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">•</span>
            <span class="text-small"><strong>Centrum:</strong> Wordt herberekend per nieuw adres</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    background: rgba(0, 0, 0, 0.03);
    color: var(--color-dark-gray);
  }
  
  .calendar-day:hover:not(.disabled):not(.empty):not(.past):not(.blocked) {
    transform: scale(1.08);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }
  
  .calendar-day.empty {
    background: transparent;
    cursor: default;
  }
  
  .calendar-day.past {
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.25);
    cursor: not-allowed;
  }
  
  /* Premium Groen - Beschikbaar */
  .calendar-day.available {
    background: rgba(16, 185, 129, 0.15);
    color: #065F46;
    font-weight: 500;
  }
  
  .calendar-day.available:hover {
    background: #10B981;
    color: white;
  }
  
  /* Premium Rood - Geblokkeerd */
  .calendar-day.blocked {
    background: rgba(239, 68, 68, 0.12);
    color: #991B1B;
    cursor: not-allowed;
  }
  
  .calendar-day.today {
    border: 2px solid var(--color-navy);
    font-weight: 600;
  }
  
  .calendar-day.selected {
    background: var(--color-navy) !important;
    color: white !important;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(27, 38, 59, 0.3);
  }
  
  .calendar-day .star-indicator {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.625rem;
    line-height: 1;
  }
  
  .calendar-day.available .star-indicator {
    color: #F59E0B;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
  }
  
  .calendar-day.selected .star-indicator {
    color: #FCD34D;
    text-shadow: none;
  }
</style>

<script>
  let currentLat = null;
  let currentLng = null;
  let currentSuggestions = [];
  let geocodeTimeout = null;
  let calendarData = {}; // Stores delivery counts per date
  let selectedCalendarDate = null;

  document.addEventListener('DOMContentLoaded', function() {
    initAddressGeocoding();
    renderCalendar();
    loadCalendarData();
  });

  function initAddressGeocoding() {
    const addressInput = document.getElementById('delivery-address');
    if (!addressInput) return;

    addressInput.addEventListener('input', function() {
      const address = this.value.trim();
      clearTimeout(geocodeTimeout);
      
      if (address.length >= 5) {
        geocodeTimeout = setTimeout(() => geocodeAddress(address), 800);
      } else {
        hideGeocodeStatus();
        document.getElementById('address-hint').style.display = 'none';
        // Reset region-specific data but keep calendar visible
        // Only remove region-specific flags, keep capacity data
        Object.keys(calendarData).forEach(dateStr => {
          if (calendarData[dateStr].has_region_deliveries) {
            delete calendarData[dateStr].has_region_deliveries;
            delete calendarData[dateStr].count;
            delete calendarData[dateStr].region_id;
            delete calendarData[dateStr].region_name;
          }
        });
        renderCalendar();
      }
    });
  }

  let currentFormattedAddress = null;

  function geocodeAddress(address) {
    showGeocodeStatus('loading', 'Adres zoeken...');
    
    fetch(`/api/geocode?address=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showGeocodeStatus('error', data.error);
          hideSuggestions();
          currentFormattedAddress = null;
          document.getElementById('address-hint').style.display = 'none';
          // Reset region data but keep calendar visible
          calendarData = {};
          renderCalendar();
          return;
        }
        
        currentLat = data.lat;
        currentLng = data.lng;
        currentFormattedAddress = data.formatted_address;
        document.getElementById('lat-input').value = data.lat;
        document.getElementById('lng-input').value = data.lng;
        
        showGeocodeStatus('success', 'Gevonden: ' + data.formatted_address, true);
        document.getElementById('address-hint').style.display = 'inline';
        loadLocationSuggestions(data.lat, data.lng);
      })
      .catch(error => {
        showGeocodeStatus('error', 'Kon adres niet vinden');
        hideSuggestions();
        currentFormattedAddress = null;
        document.getElementById('address-hint').style.display = 'none';
        // Reset region data but keep calendar visible
        calendarData = {};
        renderCalendar();
      });
  }

  function showGeocodeStatus(type, message, clickable = false) {
    const statusDiv = document.getElementById('geocode-status');
    const colors = {
      loading: { bg: 'rgba(65, 90, 119, 0.1)', color: 'var(--color-stone-blue)' },
      success: { bg: 'rgba(46, 125, 74, 0.1)', color: 'var(--color-success)' },
      error: { bg: 'rgba(155, 44, 44, 0.1)', color: 'var(--color-error)' }
    };
    statusDiv.style.background = colors[type].bg;
    statusDiv.style.color = colors[type].color;
    statusDiv.style.padding = '0.5rem 0.75rem';
    statusDiv.style.borderRadius = '6px';
    statusDiv.style.fontSize = '0.875rem';
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
    
    // Make clickable if it's a success status
    if (clickable && type === 'success') {
      statusDiv.style.cursor = 'pointer';
      statusDiv.style.transition = 'all 0.2s ease';
      statusDiv.title = 'Klik om dit adres te selecteren';
      
      // Add hover effect
      statusDiv.onmouseenter = function() {
        this.style.background = 'rgba(46, 125, 74, 0.2)';
        this.style.transform = 'scale(1.02)';
      };
      statusDiv.onmouseleave = function() {
        this.style.background = colors[type].bg;
        this.style.transform = 'scale(1)';
      };
      
      // Add click handler
      statusDiv.onclick = function() {
        if (currentFormattedAddress) {
          const addressInput = document.getElementById('delivery-address');
          addressInput.value = currentFormattedAddress;
          // Trigger input event to maintain consistency
          addressInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      };
    } else {
      statusDiv.style.cursor = 'default';
      statusDiv.onmouseenter = null;
      statusDiv.onmouseleave = null;
      statusDiv.onclick = null;
      statusDiv.title = '';
    }
  }

  function hideGeocodeStatus() {
    document.getElementById('geocode-status').classList.add('hidden');
  }

  function loadLocationSuggestions(lat, lng) {
    fetch(`/api/suggest-dates-by-location?lat=${lat}&lng=${lng}`)
      .then(response => response.json())
      .then(data => {
        currentSuggestions = data.suggestions || [];
        
        // Update calendar data with region-specific info (for star indicators)
        // Keep existing calendar data for days not in suggestions
        currentSuggestions.forEach(s => {
          calendarData[s.date] = {
            ...calendarData[s.date], // Keep existing availability data
            count: s.delivery_count,
            spots_left: s.spots_left,
            region_id: s.region_id,
            region_name: s.region_name,
            available_drivers: s.available_drivers,
            available_trucks: s.available_trucks,
            drivers_left: s.drivers_left,
            trucks_left: s.trucks_left,
            has_region_deliveries: s.delivery_count > 0 // Flag for star display
          };
        });
        renderCalendar();
        
        if (currentSuggestions.length > 0) {
          document.getElementById('calendar-hint').style.display = 'block';
          document.getElementById('no-suggestions').classList.add('hidden');
        } else {
          showNoSuggestions();
        }
      })
      .catch(() => {
        hideSuggestions();
        renderCalendar();
      });
  }

  function loadCalendarData() {
    // Load general availability data for all calendar days
    // This ensures all days show availability status (green for available driver + truck)
    renderCalendar();
    document.getElementById('calendar-hint').style.display = 'block';
    
    // Pre-check capacity for upcoming days to show availability
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const daysToCheck = 60; // Check next 60 days (2 months)
    
    for (let i = 0; i < daysToCheck; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() + i);
      const dateStr = formatDateString(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());
      
      // Initialize calendar data if not already set
      if (!calendarData[dateStr]) {
        calendarData[dateStr] = {};
      }
      
      // Check capacity asynchronously for days without region data
      if (!calendarData[dateStr].region_id) {
        checkDayCapacity(dateStr);
      }
    }
  }


  function showNoSuggestions() {
    document.getElementById('no-suggestions').classList.remove('hidden');
    document.getElementById('selected-region-id').value = '';
  }

  function hideSuggestions() {
    document.getElementById('no-suggestions').classList.add('hidden');
  }

  // Helper function to extract municipality from address
  function extractMunicipalityFromAddress(address) {
    if (!address) return '—';
    
    // Try to extract municipality from address (e.g., "Kerkstraat 10, 1000 Brussel, België" -> "Brussel")
    const addressParts = address.split(',');
    if (addressParts.length >= 2) {
      const postalPart = addressParts[1].trim();
      const postalWords = postalPart.split(' ');
      if (postalWords.length >= 2) {
        // Skip postal code, get municipality (rest of the words)
        return postalWords.slice(1).join(' ') || '—';
      } else if (postalWords.length === 1) {
        return postalWords[0] || '—';
      }
    }
    return '—';
  }

  function selectDate(dateStr, regionId, regionName, deliveryCount) {
    document.getElementById('scheduled-date').value = dateStr;
    selectedCalendarDate = dateStr;
    
    // Show region info (always show, even if no region selected)
    const infoDiv = document.getElementById('region-info');
    const detailsDiv = document.getElementById('region-details');
    
    // Extract municipality from address
    const addressInput = document.getElementById('delivery-address');
    const municipality = addressInput && addressInput.value ? extractMunicipalityFromAddress(addressInput.value) : '—';
    
    if (regionId) {
      document.getElementById('selected-region-id').value = regionId;
      document.getElementById('region-input').value = regionName || '';
      
      detailsDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div><p class="text-xs text-muted">Gemeente</p><p class="font-medium">${municipality}</p></div>
          <div><p class="text-xs text-muted">Leveringen</p><p class="font-medium">${deliveryCount || 0} van 13</p></div>
          <div><p class="text-xs text-muted">Datum</p><p class="font-medium">${formatDate(dateStr)}</p></div>
          <div><p class="text-xs text-muted">Status</p><p class="font-medium badge badge-success" style="display: inline-block;">Beschikbaar</p></div>
        </div>
      `;
    } else {
      document.getElementById('selected-region-id').value = '';
      document.getElementById('region-input').value = '';
      
      detailsDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div><p class="text-xs text-muted">Gemeente</p><p class="font-medium">${municipality}</p></div>
          <div><p class="text-xs text-muted">Datum</p><p class="font-medium">${formatDate(dateStr)}</p></div>
          <div><p class="text-xs text-muted">Leveringen</p><p class="font-medium">0 van 13</p></div>
          <div><p class="text-xs text-muted">Status</p><p class="font-medium badge badge-success" style="display: inline-block;">Beschikbaar</p></div>
        </div>
      `;
    }
    
    infoDiv.classList.remove('hidden');
    renderCalendar();
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('nl-BE', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
  }

  // Cache voor capaciteitsinfo per datum
  let capacityCache = {};
  const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 
                      'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];

  // Calendar functions - Render 2 maanden
  function renderCalendar() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    // today is already normalized to midnight (00:00:00.000)
    
    // Maand 1: huidige maand
    const month1 = today.getMonth();
    const year1 = today.getFullYear();
    
    // Maand 2: volgende maand
    let month2 = month1 + 1;
    let year2 = year1;
    if (month2 > 11) {
      month2 = 0;
      year2++;
    }
    
    // Render beide maanden
    renderMonth('month1', month1, year1, today);
    renderMonth('month2', month2, year2, today);
  }

  // Helper function to format date as YYYY-MM-DD without timezone conversion
  function formatDateString(year, month, day) {
    const m = String(month + 1).padStart(2, '0');
    const d = String(day).padStart(2, '0');
    return `${year}-${m}-${d}`;
  }

  function renderMonth(containerId, month, year, today) {
    // Set label
    document.getElementById(`${containerId}-label`).textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Get the day of week for the first day (0 = Sunday, we want Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6; // Sunday becomes 6
    
    const daysContainer = document.getElementById(`${containerId}-days`);
    daysContainer.innerHTML = '';
    
    // Empty cells before the first day
    for (let i = 0; i < startDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      daysContainer.appendChild(emptyCell);
    }
    
    // Days of the month
    for (let day = 1; day <= lastDay.getDate(); day++) {
      // Create date object normalized to local midnight
      const dateObj = new Date(year, month, day, 0, 0, 0, 0);
      const dateStr = formatDateString(year, month, day);
      
      // Compare dates by comparing year, month, day
      // This avoids timezone issues
      const isPast = (year < today.getFullYear()) || 
                     (year === today.getFullYear() && month < today.getMonth()) ||
                     (year === today.getFullYear() && month === today.getMonth() && day < today.getDate());
      const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
      const isSelected = dateStr === selectedCalendarDate;
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      dayCell.textContent = day;
      
      // Helper: is er minstens 1 chauffeur beschikbaar?
      const hasDriversAvailable = (info) => {
        if (!info) return true;
        const totalDrivers = info.total_drivers_in_system;
        const availableDrivers = info.available_drivers;
        if (totalDrivers === undefined || totalDrivers === 0) return true; // geen beperking in systeem
        return (availableDrivers || 0) > 0;
      };
      
      if (isPast) {
        dayCell.classList.add('past');
        dayCell.title = 'Verleden';
      } else {
        const dayData = calendarData[dateStr] || {};
        const capacityInfo = capacityCache[dateStr];
        let isAvailable = false;
        let blockedReason = '';
        let onSelect = null;
        
        // 1) Regio-specifieke data (uit suggesties / adres)
        if (dayData && dayData.spots_left !== undefined) {
          const driversOk = hasDriversAvailable(dayData);
          if (dayData.spots_left <= 0) {
            blockedReason = 'Regio vol (13 leveringen)';
          } else if (!driversOk) {
            blockedReason = 'Geen chauffeurs beschikbaar';
          } else {
            isAvailable = true;
            onSelect = () => selectDate(dateStr, dayData.region_id, dayData.region_name, dayData.count);
          }
        }
        // 2) Algemene capaciteit (chauffeurs/trucks) indien geen regio-data
        else if (capacityInfo !== undefined && capacityInfo !== null) {
          const driversOk = hasDriversAvailable(capacityInfo);
          const underLimit = (capacityInfo.total_deliveries || 0) < 13;
          if (driversOk && underLimit) {
            isAvailable = true;
            onSelect = () => selectDate(dateStr, null, null, 0);
          } else {
            if (!driversOk) {
              blockedReason = 'Geen chauffeurs beschikbaar';
            } else if (!underLimit) {
              blockedReason = 'Regio vol (13 leveringen)';
            } else {
              blockedReason = capacityInfo.reason || 'Geen capaciteit';
            }
          }
        }
        // 3) Gebufferde capaciteit in calendarData (indien al gecheckt)
        else if (dayData && dayData.capacity_checked !== undefined) {
          const driversOk = hasDriversAvailable(dayData);
          if (dayData.is_available && driversOk) {
            isAvailable = true;
            onSelect = () => selectDate(dateStr, null, null, 0);
          } else {
            blockedReason = dayData.reason || (!driversOk ? 'Geen chauffeurs beschikbaar' : 'Geen capaciteit');
          }
        }
        // 4) Geen data: standaard beschikbaar en async checken
        else {
          isAvailable = true;
          onSelect = () => selectDate(dateStr, null, null, 0);
          checkDayCapacity(dateStr, dayCell);
        }
        
        if (isAvailable) {
          dayCell.classList.add('available');
          if (onSelect) dayCell.onclick = onSelect;
        } else {
          dayCell.classList.add('blocked');
          if (blockedReason) {
            dayCell.title = blockedReason;
          }
          dayCell.onclick = null;
        }
      }
      
      if (isToday) {
        dayCell.classList.add('today');
      }
      
      if (isSelected) {
        dayCell.classList.add('selected');
      }
      
      // Add star indicator if there are existing deliveries in the same region
      // Only show when we have region-specific data (address has been entered)
      if (!isPast && calendarData[dateStr] && calendarData[dateStr].has_region_deliveries && calendarData[dateStr].count > 0) {
        const starIndicator = document.createElement('span');
        starIndicator.className = 'star-indicator';
        starIndicator.textContent = '⭐';
        starIndicator.title = `${calendarData[dateStr].count} levering(en) in deze regio op deze datum`;
        dayCell.appendChild(starIndicator);
      }
      
      daysContainer.appendChild(dayCell);
    }
  }

  // Async check capaciteit voor een specifieke dag
  function checkDayCapacity(dateStr, dayCell = null) {
    // Voorkom duplicate requests
    if (capacityCache[dateStr] !== undefined) return;
    capacityCache[dateStr] = null; // Mark as loading
    
    fetch(`/api/check-daily-capacity?date=${dateStr}`)
      .then(response => response.json())
      .then(data => {
        capacityCache[dateStr] = data;
        
        // Store in calendarData for later use
        if (!calendarData[dateStr]) {
          calendarData[dateStr] = {};
        }
        const driversOk = (data.total_drivers_in_system === 0) || (data.available_drivers || 0) > 0;
        const underLimit = (data.total_deliveries || 0) < 13;
        calendarData[dateStr] = {
          ...calendarData[dateStr],
          capacity_checked: true,
          is_available: driversOk && underLimit,
          available_drivers: data.available_drivers,
          total_drivers_in_system: data.total_drivers_in_system,
          available_trucks: data.available_trucks,
          total_deliveries: data.total_deliveries,
          reason: data.reason
        };
        
        // Update the cell styling if dayCell is provided (during render)
        if (dayCell) {
          if (!(driversOk && underLimit)) {
            dayCell.classList.remove('available');
            dayCell.classList.add('blocked');
            if (!driversOk) {
              dayCell.title = 'Geen chauffeurs beschikbaar';
            } else if (!underLimit) {
              dayCell.title = 'Regio vol (13 leveringen)';
            } else {
              dayCell.title = data.reason || 'Geen capaciteit (chauffeurs/trucks)';
            }
            dayCell.onclick = null;
          }
        } else {
          // If no dayCell, trigger a re-render to update the calendar
          renderCalendar();
        }
      })
      .catch(error => {
        console.error('Capacity check failed for', dateStr, error);
        // Keep as available on error
        capacityCache[dateStr] = { is_valid: true };
        if (!calendarData[dateStr]) {
          calendarData[dateStr] = {};
        }
        calendarData[dateStr] = {
          ...calendarData[dateStr],
          capacity_checked: true,
          is_available: true
        };
      });
  }
</script>
{% endblock %}
