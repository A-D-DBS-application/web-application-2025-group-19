{% extends 'base.html' %}
{% block title %}Nieuwe Levering â€” Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Nieuwe Levering Plannen</h1>
  <p class="page-subtitle">Plan een nieuwe levering door het formulier in te vullen.</p>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
  <!-- Formulier -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="font-semibold">Leveringsgegevens</h2>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('main.schedule') }}" id="delivery-form">
          <!-- Hidden fields -->
          <input type="hidden" name="lat" id="lat-input" value="">
          <input type="hidden" name="lng" id="lng-input" value="">
          <input type="hidden" name="selected_region_id" id="selected-region-id" value="">
          <input type="hidden" name="region_id" id="region-input" value="">

          <div class="form-group">
            <label class="form-label">Adres</label>
            <input type="text" name="address" id="delivery-address" placeholder="Kerkstraat 10, 1000 Brussel" class="form-input" required>
            <div id="geocode-status" class="mt-2 hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Leveringsdatum</label>
            <input type="date" name="scheduled_date" id="scheduled-date" class="form-input" required>
            <div id="location-suggestions" class="mt-3 hidden">
              <p class="text-small font-medium mb-2" style="color: var(--color-dark-gray);">Voorgestelde datums in deze regio:</p>
              <div id="suggestion-cards" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            </div>
            <div id="no-suggestions" class="mt-3 hidden">
              <p class="text-small text-muted">Dit adres valt niet binnen een bestaande regio. Er wordt een nieuwe regio aangemaakt.</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Product ID</label>
            <input type="number" name="order_id" placeholder="12345" class="form-input" required>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Levering Plannen</button>
</form>
      </div>
    </div>

    <!-- Kalender -->
    <div class="card mb-4">
      <div class="card-header flex justify-between items-center">
        <h3 class="font-semibold flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Kalender
        </h3>
        <div class="flex items-center gap-2">
          <button type="button" onclick="prevMonth()" class="btn btn-ghost btn-sm" style="padding: 0.25rem 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <span id="calendar-month-label" class="font-medium" style="min-width: 140px; text-align: center;"></span>
          <button type="button" onclick="nextMonth()" class="btn btn-ghost btn-sm" style="padding: 0.25rem 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- Legenda -->
        <div class="flex flex-wrap gap-3 mb-4 text-xs">
          <div class="flex items-center gap-1">
            <span style="width: 12px; height: 12px; border-radius: 3px; background: var(--color-sky-accent);"></span>
            <span class="text-muted">Beschikbaar</span>
          </div>
          <div class="flex items-center gap-1">
            <span style="width: 12px; height: 12px; border-radius: 3px; background: #F59E0B;"></span>
            <span class="text-muted">Bijna vol (â‰¤3 plekken)</span>
          </div>
          <div class="flex items-center gap-1">
            <span style="width: 12px; height: 12px; border-radius: 3px; background: rgba(155, 44, 44, 0.3);"></span>
            <span class="text-muted">Geen capaciteit</span>
          </div>
          <div class="flex items-center gap-1">
            <span style="width: 12px; height: 12px; border-radius: 3px; background: rgba(0,0,0,0.08);"></span>
            <span class="text-muted">Verleden</span>
          </div>
        </div>
        
        <!-- Kalender Grid -->
        <div id="calendar-container">
          <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Ma</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Di</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Wo</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Do</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Vr</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Za</div>
            <div class="text-center text-xs font-medium text-muted" style="padding: 8px 0;">Zo</div>
          </div>
          <div id="calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
        </div>
        
        <p id="calendar-hint" class="text-xs text-muted mt-3" style="display: none;">
          Klik op een dag om deze te selecteren als leveringsdatum.
        </p>
      </div>
    </div>

    <!-- Regio Info -->
    <div id="region-info" class="card hidden">
      <div class="card-header">
        <h3 class="font-semibold">Geselecteerde Regio</h3>
      </div>
      <div class="card-body" id="region-details"></div>
    </div>
  </div>

  <!-- Zijbalk -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Hoe het werkt</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">1</div>
            <p class="text-small">Voer het volledige leveradres in</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">2</div>
            <p class="text-small">Het systeem zoekt automatisch regio's binnen 30km</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">3</div>
            <p class="text-small">Datums met minder dan 13 leveringen worden voorgesteld</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">4</div>
            <p class="text-small">Kies een datum en het adres wordt toegevoegd</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Regio Regels</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Straal:</strong> 30 km vanaf centrum</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Max leveringen:</strong> 13 per dag per regio</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Centrum:</strong> Wordt herberekend per nieuw adres</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    background: rgba(0, 0, 0, 0.02);
    color: var(--color-dark-gray);
  }
  
  .calendar-day:hover:not(.disabled):not(.empty) {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .calendar-day.empty {
    background: transparent;
    cursor: default;
  }
  
  .calendar-day.past {
    background: rgba(0, 0, 0, 0.04);
    color: rgba(0, 0, 0, 0.3);
    cursor: not-allowed;
  }
  
  .calendar-day.available {
    background: rgba(126, 184, 218, 0.2);
    color: var(--color-navy);
    font-weight: 500;
  }
  
  .calendar-day.available:hover {
    background: var(--color-sky-accent);
    color: white;
  }
  
  .calendar-day.limited {
    background: rgba(245, 158, 11, 0.2);
    color: #92600E;
    font-weight: 500;
  }
  
  .calendar-day.limited:hover {
    background: #F59E0B;
    color: white;
  }
  
  .calendar-day.full {
    background: rgba(0, 0, 0, 0.08);
    color: rgba(0, 0, 0, 0.4);
    cursor: not-allowed;
  }
  
  .calendar-day.no-capacity {
    background: rgba(155, 44, 44, 0.15);
    color: rgba(155, 44, 44, 0.7);
    cursor: not-allowed;
  }
  
  .calendar-day.no-capacity::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 60%;
    height: 1px;
    background: rgba(155, 44, 44, 0.4);
    transform: translate(-50%, -50%) rotate(-45deg);
  }
  
  .calendar-day.today {
    border: 2px solid var(--color-navy);
  }
  
  .calendar-day.selected {
    background: var(--color-navy) !important;
    color: white !important;
    font-weight: 600;
  }
  
  .calendar-day .delivery-count {
    position: absolute;
    bottom: 2px;
    right: 2px;
    font-size: 0.6rem;
    opacity: 0.7;
  }
</style>

<script>
  let currentLat = null;
  let currentLng = null;
  let currentSuggestions = [];
  let geocodeTimeout = null;
  let calendarMonth = new Date().getMonth();
  let calendarYear = new Date().getFullYear();
  let calendarData = {}; // Stores delivery counts per date
  let selectedCalendarDate = null;

  document.addEventListener('DOMContentLoaded', function() {
    initAddressGeocoding();
    renderCalendar();
    loadCalendarData();
  });

  function initAddressGeocoding() {
    const addressInput = document.getElementById('delivery-address');
    if (!addressInput) return;

    addressInput.addEventListener('input', function() {
      const address = this.value.trim();
      clearTimeout(geocodeTimeout);
      
      if (address.length >= 5) {
        geocodeTimeout = setTimeout(() => geocodeAddress(address), 800);
      } else {
        hideGeocodeStatus();
        hideSuggestions();
      }
    });
  }

  function geocodeAddress(address) {
    showGeocodeStatus('loading', 'Adres zoeken...');
    
    fetch(`/api/geocode?address=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showGeocodeStatus('error', data.error);
          hideSuggestions();
          return;
        }
        
        currentLat = data.lat;
        currentLng = data.lng;
        document.getElementById('lat-input').value = data.lat;
        document.getElementById('lng-input').value = data.lng;
        
        showGeocodeStatus('success', 'Gevonden: ' + data.formatted_address);
        loadLocationSuggestions(data.lat, data.lng);
        loadCalendarData(); // Reload calendar with location-specific data
      })
      .catch(error => {
        showGeocodeStatus('error', 'Kon adres niet vinden');
        hideSuggestions();
      });
  }

  function showGeocodeStatus(type, message) {
    const statusDiv = document.getElementById('geocode-status');
    const colors = {
      loading: { bg: 'rgba(65, 90, 119, 0.1)', color: 'var(--color-stone-blue)' },
      success: { bg: 'rgba(46, 125, 74, 0.1)', color: 'var(--color-success)' },
      error: { bg: 'rgba(155, 44, 44, 0.1)', color: 'var(--color-error)' }
    };
    statusDiv.style.background = colors[type].bg;
    statusDiv.style.color = colors[type].color;
    statusDiv.style.padding = '0.5rem 0.75rem';
    statusDiv.style.borderRadius = '6px';
    statusDiv.style.fontSize = '0.875rem';
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
  }

  function hideGeocodeStatus() {
    document.getElementById('geocode-status').classList.add('hidden');
  }

  function loadLocationSuggestions(lat, lng) {
    fetch(`/api/suggest-dates-by-location?lat=${lat}&lng=${lng}`)
      .then(response => response.json())
      .then(data => {
        currentSuggestions = data.suggestions || [];
        
        // Update calendar data with suggestions (including capacity info)
        calendarData = {};
        currentSuggestions.forEach(s => {
          calendarData[s.date] = {
            count: s.delivery_count,
            spots_left: s.spots_left,
            region_id: s.region_id,
            region_name: s.region_name,
            available_drivers: s.available_drivers,
            available_trucks: s.available_trucks,
            drivers_left: s.drivers_left,
            trucks_left: s.trucks_left
          };
        });
        renderCalendar();
        
        if (currentSuggestions.length > 0) {
          showSuggestions(currentSuggestions);
          document.getElementById('calendar-hint').style.display = 'block';
        } else {
          showNoSuggestions();
        }
      })
      .catch(() => hideSuggestions());
  }

  function loadCalendarData() {
    // Load general availability data for calendar
    if (currentLat && currentLng) {
      // Already loaded via loadLocationSuggestions
      return;
    }
    
    // Default: show all days as available (new region)
    renderCalendar();
    document.getElementById('calendar-hint').style.display = 'block';
  }

  function showSuggestions(suggestions) {
    const container = document.getElementById('location-suggestions');
    const cardsDiv = document.getElementById('suggestion-cards');
    document.getElementById('no-suggestions').classList.add('hidden');
    container.classList.remove('hidden');
    
    let html = '';
    suggestions.slice(0, 5).forEach((s, index) => {
      // Capaciteitsinfo icons
      const driversInfo = s.available_drivers !== undefined 
        ? `<span title="${s.available_drivers} chauffeur(s) beschikbaar">ðŸ‘¤ ${s.drivers_left || s.available_drivers}</span>` 
        : '';
      const trucksInfo = s.available_trucks !== undefined 
        ? `<span title="${s.available_trucks} truck(s) beschikbaar">ðŸšš ${s.trucks_left !== undefined ? s.trucks_left : s.available_trucks}</span>` 
        : '';
      
      html += `
        <div onclick="selectSuggestion(${index})" style="padding: 0.75rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; cursor: pointer; transition: all 0.15s;" 
             onmouseover="this.style.borderColor='var(--color-sky-accent)'; this.style.background='rgba(126,184,218,0.08)';"
             onmouseout="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.background='transparent';"
             data-index="${index}">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="font-medium">${formatDate(s.date)}</span>
            <span class="badge ${s.spots_left <= 3 ? 'badge-warning' : 'badge-success'}">${s.spots_left} plekken vrij</span>
          </div>
          <div class="text-xs text-muted mt-1" style="display: flex; justify-content: space-between; align-items: center;">
            <span>${s.region_name} Â· ${s.distance_km} km Â· ${s.delivery_count}/13</span>
            <span style="display: flex; gap: 8px;">${driversInfo} ${trucksInfo}</span>
          </div>
        </div>
      `;
    });
    cardsDiv.innerHTML = html;
  }

  function showNoSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.remove('hidden');
    document.getElementById('selected-region-id').value = '';
  }

  function hideSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.add('hidden');
  }

  function selectSuggestion(index) {
    const s = currentSuggestions[index];
    if (!s) return;
    
    selectDate(s.date, s.region_id, s.region_name, s.delivery_count);
  }

  function selectDate(dateStr, regionId, regionName, deliveryCount) {
    document.getElementById('scheduled-date').value = dateStr;
    selectedCalendarDate = dateStr;
    
    if (regionId) {
      document.getElementById('selected-region-id').value = regionId;
      document.getElementById('region-input').value = regionName || '';
      
      // Show region info
      const infoDiv = document.getElementById('region-info');
      const detailsDiv = document.getElementById('region-details');
      detailsDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div><p class="text-xs text-muted">Regio</p><p class="font-medium">${regionName}</p></div>
          <div><p class="text-xs text-muted">Leveringen</p><p class="font-medium">${deliveryCount || 0} van 13</p></div>
          <div><p class="text-xs text-muted">Datum</p><p class="font-medium">${formatDate(dateStr)}</p></div>
          <div><p class="text-xs text-muted">Status</p><p class="font-medium badge badge-success" style="display: inline-block;">Beschikbaar</p></div>
        </div>
      `;
      infoDiv.classList.remove('hidden');
    } else {
      document.getElementById('selected-region-id').value = '';
      document.getElementById('region-input').value = '';
      document.getElementById('region-info').classList.add('hidden');
    }
    
    renderCalendar();
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('nl-BE', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
  }

  // Cache voor capaciteitsinfo per datum
  let capacityCache = {};

  // Calendar functions
  function renderCalendar() {
    const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 
                        'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
    
    document.getElementById('calendar-month-label').textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
    
    const firstDay = new Date(calendarYear, calendarMonth, 1);
    const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Get the day of week for the first day (0 = Sunday, we want Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6; // Sunday becomes 6
    
    const daysContainer = document.getElementById('calendar-days');
    daysContainer.innerHTML = '';
    
    // Empty cells before the first day
    for (let i = 0; i < startDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      daysContainer.appendChild(emptyCell);
    }
    
    // Days of the month
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateObj = new Date(calendarYear, calendarMonth, day);
      const dateStr = dateObj.toISOString().split('T')[0];
      const isPast = dateObj < today;
      const isToday = dateObj.getTime() === today.getTime();
      const isSelected = dateStr === selectedCalendarDate;
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      dayCell.textContent = day;
      
      if (isPast) {
        dayCell.classList.add('past');
      } else {
        // Check availability from calendar data
        const dayData = calendarData[dateStr];
        
        if (dayData) {
          if (dayData.spots_left <= 0) {
            dayCell.classList.add('full');
          } else if (dayData.spots_left <= 3) {
            dayCell.classList.add('limited');
            dayCell.onclick = () => selectDate(dateStr, dayData.region_id, dayData.region_name, dayData.count);
          } else {
            dayCell.classList.add('available');
            dayCell.onclick = () => selectDate(dateStr, dayData.region_id, dayData.region_name, dayData.count);
          }
        } else {
          // No region data = check if we need capacity info
          // If we already have capacity in cache, use it
          if (capacityCache[dateStr] !== undefined) {
            if (capacityCache[dateStr].is_valid) {
              dayCell.classList.add('available');
              dayCell.onclick = () => selectDate(dateStr, null, null, 0);
            } else {
              dayCell.classList.add('no-capacity');
              dayCell.title = capacityCache[dateStr].reason || 'Geen capaciteit';
            }
          } else {
            // Default to available, async load capacity
            dayCell.classList.add('available');
            dayCell.onclick = () => selectDate(dateStr, null, null, 0);
            // Async check capacity for this date
            checkDayCapacity(dateStr, dayCell);
          }
        }
      }
      
      if (isToday) {
        dayCell.classList.add('today');
      }
      
      if (isSelected) {
        dayCell.classList.add('selected');
      }
      
      daysContainer.appendChild(dayCell);
    }
  }

  function prevMonth() {
    calendarMonth--;
    if (calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    renderCalendar();
  }

  function nextMonth() {
    calendarMonth++;
    if (calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    renderCalendar();
  }

  // Async check capaciteit voor een specifieke dag
  function checkDayCapacity(dateStr, dayCell) {
    // Voorkom duplicate requests
    if (capacityCache[dateStr] !== undefined) return;
    capacityCache[dateStr] = null; // Mark as loading
    
    fetch(`/api/check-daily-capacity?date=${dateStr}`)
      .then(response => response.json())
      .then(data => {
        capacityCache[dateStr] = data;
        
        // Update the cell styling based on capacity
        if (!data.is_valid) {
          dayCell.classList.remove('available');
          dayCell.classList.add('no-capacity');
          dayCell.title = data.reason || 'Geen capaciteit (chauffeurs/trucks)';
          dayCell.onclick = null;
          dayCell.style.cursor = 'not-allowed';
        }
      })
      .catch(error => {
        console.error('Capacity check failed for', dateStr, error);
        // Keep as available on error
        capacityCache[dateStr] = { is_valid: true };
      });
  }
</script>
{% endblock %}
