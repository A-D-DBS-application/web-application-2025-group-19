{% extends 'base.html' %}
{% block title %}Nieuwe Levering â€” Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Nieuwe Levering Plannen</h1>
  <p class="page-subtitle">Plan een nieuwe levering door het formulier in te vullen.</p>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
  <!-- Formulier -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="font-semibold">Leveringsgegevens</h2>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('main.schedule') }}" id="delivery-form">
          <!-- Hidden fields -->
          <input type="hidden" name="lat" id="lat-input" value="">
          <input type="hidden" name="lng" id="lng-input" value="">
          <input type="hidden" name="selected_region_id" id="selected-region-id" value="">
          <input type="hidden" name="region_id" id="region-input" value="">

          <div class="form-group">
            <label class="form-label">Adres</label>
            <input type="text" name="address" id="delivery-address" placeholder="Kerkstraat 10, 1000 Brussel" class="form-input" required>
            <div id="geocode-status" class="mt-2 hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Leveringsdatum</label>
            <input type="date" name="scheduled_date" id="scheduled-date" class="form-input" required>
            <div id="location-suggestions" class="mt-3 hidden">
              <p class="text-small font-medium mb-2" style="color: var(--color-dark-gray);">Voorgestelde datums in deze regio:</p>
              <div id="suggestion-cards" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            </div>
            <div id="no-suggestions" class="mt-3 hidden">
              <p class="text-small text-muted">Dit adres valt niet binnen een bestaande regio. Er wordt een nieuwe regio aangemaakt.</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Product ID</label>
            <input type="number" name="order_id" placeholder="12345" class="form-input" required>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Levering Plannen</button>
</form>
      </div>
    </div>

    <!-- Kalender Overzicht - 2 Maanden -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Leveringskalender
        </h3>
        <p class="text-small text-muted mt-1">Overzicht van de komende 2 maanden</p>
      </div>
      <div class="card-body">
        <!-- Legenda -->
        <div class="flex flex-wrap gap-4 mb-4 text-xs">
          <div class="flex items-center gap-2">
            <span style="width: 14px; height: 14px; border-radius: 4px; background: #10B981;"></span>
            <span>Beschikbaar</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="width: 14px; height: 14px; border-radius: 4px; background: #EF4444;"></span>
            <span>Vol / Geblokkeerd</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="width: 14px; height: 14px; border-radius: 4px; background: rgba(0,0,0,0.1);"></span>
            <span>Verleden</span>
          </div>
        </div>
        
        <!-- Twee Maanden Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <!-- Maand 1 -->
          <div>
            <h4 id="month1-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
            <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
            </div>
            <div id="month1-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
          </div>
          
          <!-- Maand 2 -->
          <div>
            <h4 id="month2-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
            <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
              <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
            </div>
            <div id="month2-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
          </div>
        </div>
        
        <p id="calendar-hint" class="text-xs text-muted mt-4" style="text-align: center;">
          Klik op een groene dag om deze te selecteren als leveringsdatum.
        </p>
      </div>
    </div>

    <!-- Regio Info -->
    <div id="region-info" class="card hidden">
      <div class="card-header">
        <h3 class="font-semibold">Geselecteerde Regio</h3>
      </div>
      <div class="card-body" id="region-details"></div>
    </div>
  </div>

  <!-- Zijbalk -->
  <div>
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Hoe het werkt</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">1</div>
            <p class="text-small">Voer het volledige leveradres in</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">2</div>
            <p class="text-small">Het systeem zoekt automatisch regio's binnen 30km</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">3</div>
            <p class="text-small">Datums met minder dan 13 leveringen worden voorgesteld</p>
          </div>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-navy); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">4</div>
            <p class="text-small">Kies een datum en het adres wordt toegevoegd</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h3 class="font-semibold">Regio Regels</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Straal:</strong> 30 km vanaf centrum</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Max leveringen:</strong> 13 per dag per regio</span>
          </div>
          <div class="flex items-center gap-2">
            <span style="color: var(--color-success);">â€¢</span>
            <span class="text-small"><strong>Centrum:</strong> Wordt herberekend per nieuw adres</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    background: rgba(0, 0, 0, 0.03);
    color: var(--color-dark-gray);
  }
  
  .calendar-day:hover:not(.disabled):not(.empty):not(.past):not(.blocked) {
    transform: scale(1.08);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }
  
  .calendar-day.empty {
    background: transparent;
    cursor: default;
  }
  
  .calendar-day.past {
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.25);
    cursor: not-allowed;
  }
  
  /* Premium Groen - Beschikbaar */
  .calendar-day.available {
    background: rgba(16, 185, 129, 0.15);
    color: #065F46;
    font-weight: 500;
  }
  
  .calendar-day.available:hover {
    background: #10B981;
    color: white;
  }
  
  /* Premium Rood - Geblokkeerd */
  .calendar-day.blocked {
    background: rgba(239, 68, 68, 0.12);
    color: #991B1B;
    cursor: not-allowed;
  }
  
  .calendar-day.today {
    border: 2px solid var(--color-navy);
    font-weight: 600;
  }
  
  .calendar-day.selected {
    background: var(--color-navy) !important;
    color: white !important;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(27, 38, 59, 0.3);
  }
</style>

<script>
  let currentLat = null;
  let currentLng = null;
  let currentSuggestions = [];
  let geocodeTimeout = null;
  let calendarData = {}; // Stores delivery counts per date
  let selectedCalendarDate = null;
  let selectedSuggestionIndex = null;

  document.addEventListener('DOMContentLoaded', function() {
    initAddressGeocoding();
    renderCalendar();
    loadCalendarData();
  });

  function initAddressGeocoding() {
    const addressInput = document.getElementById('delivery-address');
    if (!addressInput) return;

    addressInput.addEventListener('input', function() {
      const address = this.value.trim();
      clearTimeout(geocodeTimeout);
      
      if (address.length >= 5) {
        geocodeTimeout = setTimeout(() => geocodeAddress(address), 800);
      } else {
        hideGeocodeStatus();
        hideSuggestions();
      }
    });
  }

  let currentFormattedAddress = null;

  function geocodeAddress(address) {
    showGeocodeStatus('loading', 'Adres zoeken...');
    
    fetch(`/api/geocode?address=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showGeocodeStatus('error', data.error);
          hideSuggestions();
          currentFormattedAddress = null;
          return;
        }
        
        currentLat = data.lat;
        currentLng = data.lng;
        currentFormattedAddress = data.formatted_address;
        document.getElementById('lat-input').value = data.lat;
        document.getElementById('lng-input').value = data.lng;
        
        showGeocodeStatus('success', 'Gevonden: ' + data.formatted_address, true);
        loadLocationSuggestions(data.lat, data.lng);
        loadCalendarData(); // Reload calendar with location-specific data
      })
      .catch(error => {
        showGeocodeStatus('error', 'Kon adres niet vinden');
        hideSuggestions();
        currentFormattedAddress = null;
      });
  }

  function showGeocodeStatus(type, message, clickable = false) {
    const statusDiv = document.getElementById('geocode-status');
    const colors = {
      loading: { bg: 'rgba(65, 90, 119, 0.1)', color: 'var(--color-stone-blue)' },
      success: { bg: 'rgba(46, 125, 74, 0.1)', color: 'var(--color-success)' },
      error: { bg: 'rgba(155, 44, 44, 0.1)', color: 'var(--color-error)' }
    };
    statusDiv.style.background = colors[type].bg;
    statusDiv.style.color = colors[type].color;
    statusDiv.style.padding = '0.5rem 0.75rem';
    statusDiv.style.borderRadius = '6px';
    statusDiv.style.fontSize = '0.875rem';
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
    
    // Make clickable if it's a success status
    if (clickable && type === 'success') {
      statusDiv.style.cursor = 'pointer';
      statusDiv.style.transition = 'all 0.2s ease';
      statusDiv.title = 'Klik om dit adres te selecteren';
      
      // Add hover effect
      statusDiv.onmouseenter = function() {
        this.style.background = 'rgba(46, 125, 74, 0.2)';
        this.style.transform = 'scale(1.02)';
      };
      statusDiv.onmouseleave = function() {
        this.style.background = colors[type].bg;
        this.style.transform = 'scale(1)';
      };
      
      // Add click handler
      statusDiv.onclick = function() {
        if (currentFormattedAddress) {
          const addressInput = document.getElementById('delivery-address');
          addressInput.value = currentFormattedAddress;
          // Trigger input event to maintain consistency
          addressInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      };
    } else {
      statusDiv.style.cursor = 'default';
      statusDiv.onmouseenter = null;
      statusDiv.onmouseleave = null;
      statusDiv.onclick = null;
      statusDiv.title = '';
    }
  }

  function hideGeocodeStatus() {
    document.getElementById('geocode-status').classList.add('hidden');
  }

  function loadLocationSuggestions(lat, lng) {
    fetch(`/api/suggest-dates-by-location?lat=${lat}&lng=${lng}`)
      .then(response => response.json())
      .then(data => {
        currentSuggestions = data.suggestions || [];
        
        // Update calendar data with suggestions (including capacity info)
        calendarData = {};
        currentSuggestions.forEach(s => {
          calendarData[s.date] = {
            count: s.delivery_count,
            spots_left: s.spots_left,
            region_id: s.region_id,
            region_name: s.region_name,
            available_drivers: s.available_drivers,
            available_trucks: s.available_trucks,
            drivers_left: s.drivers_left,
            trucks_left: s.trucks_left
          };
        });
        renderCalendar();
        
        if (currentSuggestions.length > 0) {
          showSuggestions(currentSuggestions);
          document.getElementById('calendar-hint').style.display = 'block';
        } else {
          showNoSuggestions();
        }
      })
      .catch(() => hideSuggestions());
  }

  function loadCalendarData() {
    // Load general availability data for calendar
    if (currentLat && currentLng) {
      // Already loaded via loadLocationSuggestions
      return;
    }
    
    // Default: show all days as available (new region)
    renderCalendar();
    document.getElementById('calendar-hint').style.display = 'block';
  }

  function showSuggestions(suggestions) {
    const container = document.getElementById('location-suggestions');
    const cardsDiv = document.getElementById('suggestion-cards');
    document.getElementById('no-suggestions').classList.add('hidden');
    container.classList.remove('hidden');
    
    let html = '';
    suggestions.slice(0, 5).forEach((s, index) => {
      // Check if this suggestion is selected
      const isSelected = selectedSuggestionIndex === index || selectedCalendarDate === s.date;
      const selectedStyle = isSelected 
        ? 'border: 2px solid var(--color-navy); background: rgba(27, 38, 59, 0.08);' 
        : 'border: 1px solid rgba(0,0,0,0.1); background: transparent;';
      
      // Capaciteitsinfo icons
      const driversInfo = s.available_drivers !== undefined 
        ? `<span title="${s.available_drivers} chauffeur(s) beschikbaar">ðŸ‘¤ ${s.drivers_left || s.available_drivers}</span>` 
        : '';
      const trucksInfo = s.available_trucks !== undefined 
        ? `<span title="${s.available_trucks} truck(s) beschikbaar">ðŸšš ${s.trucks_left !== undefined ? s.trucks_left : s.available_trucks}</span>` 
        : '';
      
      html += `
        <div onclick="selectSuggestion(${index})" 
             class="suggestion-card" 
             data-index="${index}"
             data-date="${s.date}"
             style="padding: 0.75rem; ${selectedStyle} border-radius: 6px; cursor: pointer; transition: all 0.15s; margin-bottom: 0.5rem;" 
             onmouseover="if (!this.classList.contains('selected')) { this.style.borderColor='var(--color-sky-accent)'; this.style.background='rgba(126,184,218,0.08)'; }"
             onmouseout="if (!this.classList.contains('selected')) { this.style.borderColor='rgba(0,0,0,0.1)'; this.style.background='transparent'; }">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="font-medium">${formatDate(s.date)}</span>
            <span class="badge ${s.spots_left <= 3 ? 'badge-warning' : 'badge-success'}">${s.spots_left} plekken vrij</span>
          </div>
          <div class="text-xs text-muted mt-1" style="display: flex; justify-content: space-between; align-items: center;">
            <span>${s.region_name} Â· ${s.distance_km} km Â· ${s.delivery_count}/13</span>
            <span style="display: flex; gap: 8px;">${driversInfo} ${trucksInfo}</span>
          </div>
        </div>
      `;
    });
    cardsDiv.innerHTML = html;
    
    // Update selected state
    updateSuggestionSelection();
  }
  
  function updateSuggestionSelection() {
    // Remove selected class from all cards
    document.querySelectorAll('.suggestion-card').forEach(card => {
      card.classList.remove('selected');
      const isSelected = selectedSuggestionIndex !== null && 
                        parseInt(card.getAttribute('data-index')) === selectedSuggestionIndex;
      if (isSelected || card.getAttribute('data-date') === selectedCalendarDate) {
        card.classList.add('selected');
        card.style.border = '2px solid var(--color-navy)';
        card.style.background = 'rgba(27, 38, 59, 0.08)';
      } else {
        card.style.border = '1px solid rgba(0,0,0,0.1)';
        card.style.background = 'transparent';
      }
    });
  }

  function showNoSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.remove('hidden');
    document.getElementById('selected-region-id').value = '';
  }

  function hideSuggestions() {
    document.getElementById('location-suggestions').classList.add('hidden');
    document.getElementById('no-suggestions').classList.add('hidden');
  }

  function selectSuggestion(index) {
    const s = currentSuggestions[index];
    if (!s) return;
    
    selectedSuggestionIndex = index;
    selectDate(s.date, s.region_id, s.region_name, s.delivery_count);
    updateSuggestionSelection();
  }

  function selectDate(dateStr, regionId, regionName, deliveryCount) {
    document.getElementById('scheduled-date').value = dateStr;
    selectedCalendarDate = dateStr;
    
    // Update selected suggestion index based on date
    if (currentSuggestions && currentSuggestions.length > 0) {
      const suggestionIndex = currentSuggestions.findIndex(s => s.date === dateStr);
      if (suggestionIndex !== -1) {
        selectedSuggestionIndex = suggestionIndex;
      }
    }
    
    if (regionId) {
      document.getElementById('selected-region-id').value = regionId;
      document.getElementById('region-input').value = regionName || '';
      
      // Show region info
      const infoDiv = document.getElementById('region-info');
      const detailsDiv = document.getElementById('region-details');
      detailsDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div><p class="text-xs text-muted">Regio</p><p class="font-medium">${regionName}</p></div>
          <div><p class="text-xs text-muted">Leveringen</p><p class="font-medium">${deliveryCount || 0} van 13</p></div>
          <div><p class="text-xs text-muted">Datum</p><p class="font-medium">${formatDate(dateStr)}</p></div>
          <div><p class="text-xs text-muted">Status</p><p class="font-medium badge badge-success" style="display: inline-block;">Beschikbaar</p></div>
        </div>
      `;
      infoDiv.classList.remove('hidden');
    } else {
      document.getElementById('selected-region-id').value = '';
      document.getElementById('region-input').value = '';
      document.getElementById('region-info').classList.add('hidden');
    }
    
    renderCalendar();
    updateSuggestionSelection();
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('nl-BE', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
  }

  // Cache voor capaciteitsinfo per datum
  let capacityCache = {};
  const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 
                      'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];

  // Calendar functions - Render 2 maanden
  function renderCalendar() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Maand 1: huidige maand
    const month1 = today.getMonth();
    const year1 = today.getFullYear();
    
    // Maand 2: volgende maand
    let month2 = month1 + 1;
    let year2 = year1;
    if (month2 > 11) {
      month2 = 0;
      year2++;
    }
    
    // Render beide maanden
    renderMonth('month1', month1, year1, today);
    renderMonth('month2', month2, year2, today);
  }

  function renderMonth(containerId, month, year, today) {
    // Set label
    document.getElementById(`${containerId}-label`).textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Get the day of week for the first day (0 = Sunday, we want Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6; // Sunday becomes 6
    
    const daysContainer = document.getElementById(`${containerId}-days`);
    daysContainer.innerHTML = '';
    
    // Empty cells before the first day
    for (let i = 0; i < startDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      daysContainer.appendChild(emptyCell);
    }
    
    // Days of the month
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateObj = new Date(year, month, day);
      const dateStr = dateObj.toISOString().split('T')[0];
      const isPast = dateObj < today;
      const isToday = dateObj.getTime() === today.getTime();
      const isSelected = dateStr === selectedCalendarDate;
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      dayCell.textContent = day;
      
      if (isPast) {
        dayCell.classList.add('past');
      } else {
        // Check availability from calendar data (suggestions)
        const dayData = calendarData[dateStr];
        
        if (dayData) {
          // We hebben regio-data: check spots
          if (dayData.spots_left <= 0) {
            dayCell.classList.add('blocked');
            dayCell.title = 'Regio vol (13 leveringen)';
          } else {
            dayCell.classList.add('available');
            dayCell.onclick = () => selectDate(dateStr, dayData.region_id, dayData.region_name, dayData.count);
          }
        } else {
          // Geen regio-data: check capaciteit async
          if (capacityCache[dateStr] !== undefined && capacityCache[dateStr] !== null) {
            if (capacityCache[dateStr].is_valid) {
              dayCell.classList.add('available');
              dayCell.onclick = () => selectDate(dateStr, null, null, 0);
            } else {
              dayCell.classList.add('blocked');
              dayCell.title = capacityCache[dateStr].reason || 'Geen capaciteit';
            }
          } else {
            // Nog niet gecheckt - default available, async laden
            dayCell.classList.add('available');
            dayCell.onclick = () => selectDate(dateStr, null, null, 0);
            checkDayCapacity(dateStr, dayCell);
          }
        }
      }
      
      if (isToday) {
        dayCell.classList.add('today');
      }
      
      if (isSelected) {
        dayCell.classList.add('selected');
      }
      
      daysContainer.appendChild(dayCell);
    }
  }

  // Async check capaciteit voor een specifieke dag
  function checkDayCapacity(dateStr, dayCell) {
    // Voorkom duplicate requests
    if (capacityCache[dateStr] !== undefined) return;
    capacityCache[dateStr] = null; // Mark as loading
    
    fetch(`/api/check-daily-capacity?date=${dateStr}`)
      .then(response => response.json())
      .then(data => {
        capacityCache[dateStr] = data;
        
        // Update the cell styling based on capacity
        if (!data.is_valid) {
          dayCell.classList.remove('available');
          dayCell.classList.add('blocked');
          dayCell.title = data.reason || 'Geen capaciteit (chauffeurs/trucks)';
          dayCell.onclick = null;
        }
      })
      .catch(error => {
        console.error('Capacity check failed for', dateStr, error);
        // Keep as available on error
        capacityCache[dateStr] = { is_valid: true };
      });
  }
</script>
{% endblock %}
