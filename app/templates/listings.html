{% extends 'base.html' %}
{% block title %}Geplande Leveringen â€” Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header flex justify-between items-center">
  <div>
    <h1 class="page-title">Geplande Leveringen</h1>
    <p class="page-subtitle">Overzicht van alle geplande en uitgevoerde leveringen.</p>
  </div>
  <div class="flex gap-2">
    <a href="#" id="google-calendar-link" class="btn btn-outline" title="Voeg leveringen toe aan Google Calendar">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Toevoegen aan Google Calendar
    </a>
    <a href="{{ url_for('main.add_listing') }}" class="btn btn-primary">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Levering Plannen
    </a>
  </div>
</div>

{% if listings %}
  <div class="table-container">
    <!-- Desktop table view -->
    <table class="table">
      <thead>
        <tr>
          <th>Product Omschrijving</th>
          <th>Uur van de levering</th>
          <th>Status</th>
          <th>Geplande Datum</th>
          <th class="text-center actions-col"></th>
        </tr>
      </thead>
      <tbody>
        {% for listing in listings %}
          <tr>
            <td>
              <span class="font-medium">{{ listing.product_description or 'â€”' }}</span>
            </td>
            <td>
              <span class="text-muted">{{ listing.delivery_hour or 'â€”' }}</span>
            </td>
            <td>
              <span class="badge {% if listing.status == 'scheduled' %}badge-primary{% elif listing.status == 'delivered' %}badge-success{% else %}badge-default{% endif %}">
                {{ listing.status }}
              </span>
            </td>
            <td>
              {% if listing.scheduled_date %}
                {{ listing.scheduled_date.strftime('%d-%m-%Y') }}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
            <td class="text-center">
              <form method="POST" action="{{ url_for('main.delete_delivery', delivery_id=listing.delivery_id) }}" style="display: inline;" onsubmit="return confirm('Weet je zeker dat je deze levering wilt verwijderen?');">
                <button type="submit" class="btn btn-danger btn-sm">Verwijderen</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <!-- Mobile card view -->
    <div class="table-mobile-view" style="display: none;">
      {% for listing in listings %}
        <div class="table-mobile-card">
          <div class="table-mobile-row">
            <div class="table-mobile-label">Product Omschrijving</div>
            <div class="table-mobile-value font-medium">{{ listing.product_description or 'â€”' }}</div>
          </div>
          <div class="table-mobile-row">
            <div class="table-mobile-label">Uur van de levering</div>
            <div class="table-mobile-value">{{ listing.delivery_hour or 'â€”' }}</div>
          </div>
          <div class="table-mobile-row">
            <div class="table-mobile-label">Status</div>
            <div class="table-mobile-value">
              <span class="badge {% if listing.status == 'scheduled' %}badge-primary{% elif listing.status == 'delivered' %}badge-success{% else %}badge-default{% endif %}">
                {{ listing.status }}
              </span>
            </div>
          </div>
          <div class="table-mobile-row">
            <div class="table-mobile-label">Geplande Datum</div>
            <div class="table-mobile-value">
              {% if listing.scheduled_date %}
                {{ listing.scheduled_date.strftime('%d-%m-%Y') }}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </div>
          </div>
          <div class="table-mobile-row delete-row">
            <form method="POST" action="{{ url_for('main.delete_delivery', delivery_id=listing.delivery_id) }}" onsubmit="return confirm('Weet je zeker dat je deze levering wilt verwijderen?');">
              <button type="submit" class="btn btn-danger mobile-delete-btn">Verwijderen</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="card-footer">
      <p class="text-small text-muted">Totaal: <strong>{{ listings | length }}</strong> levering{% if listings | length != 1 %}en{% endif %}</p>
    </div>
  </div>
{% else %}
  <div class="card">
    <div class="empty-state">
      <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
      </svg>
      <p class="empty-state-title">Geen leveringen gevonden</p>
      <p class="empty-state-text">Er zijn nog geen leveringen gepland. Plan je eerste levering om te beginnen.</p>
      <a href="{{ url_for('main.add_listing') }}" class="btn btn-primary mt-4">Levering Plannen</a>
    </div>
  </div>
{% endif %}

<script>
  // Show mobile view on mobile devices
  if (window.innerWidth <= 768) {
    const tableContainers = document.querySelectorAll('.table-container');
    tableContainers.forEach(container => {
      const table = container.querySelector('.table');
      const mobileView = container.querySelector('.table-mobile-view');
      if (table && mobileView) {
        table.style.display = 'none';
        mobileView.style.display = 'block';
      }
    });
  }
  
  // Google Calendar link - direct toevoegen
  const googleCalendarLink = document.getElementById('google-calendar-link');
  
  googleCalendarLink.addEventListener('click', function(e) {
    e.preventDefault();
    
    // Download het iCal bestand direct via een link (simpler en betrouwbaarder)
    const icalUrl = window.location.origin + '{{ url_for("main.export_deliveries_ical") }}';
    
    // Maak een tijdelijk download link element
    const link = document.createElement('a');
    link.href = icalUrl;
    link.download = 'leveringen.ics';
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Verwijder link na korte delay
    setTimeout(() => {
      document.body.removeChild(link);
      
      // Toon instructies na download
      setTimeout(() => {
        const message = 'âœ… Bestand "leveringen.ics" is gedownload!\n\n' +
                       'ðŸ“… Volg deze stappen om toe te voegen aan Google Calendar:\n\n' +
                       '1. Ga naar calendar.google.com (wordt nu geopend)\n' +
                       '2. Klik op het "+" naast "Andere agenda\'s" (links)\n' +
                       '3. Kies "Importeren"\n' +
                       '4. Klik "Bestand kiezen"\n' +
                       '5. Selecteer het gedownloade "leveringen.ics" bestand\n' +
                       '6. Kies in welke agenda je de leveringen wilt toevoegen\n' +
                       '7. Klik op "Importeren"\n\n' +
                       'âœ¨ Je leveringen worden dan toegevoegd aan je Google Calendar!';
        
        if (confirm(message)) {
          // Open Google Calendar import pagina
          window.open('https://calendar.google.com/calendar/u/0/r/settings/export', '_blank');
        }
      }, 500);
    }, 100);
  });
</script>
{% endblock %}
