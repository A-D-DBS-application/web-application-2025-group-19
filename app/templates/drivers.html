{% extends 'base.html' %}
{% block title %}Bezorgers — Delivery Schedule{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Bezorgers</h1>
  <p class="page-subtitle">Beheer je bezorgers (chauffeurs & helpers) en hun beschikbaarheid.</p>
</div>

<!-- Bezorger Toevoegen -->
<div class="card mb-5">
  <div class="card-header">
    <h2 class="font-semibold flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
      </svg>
      Bezorger Toevoegen
    </h2>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('main.add_driver') }}">
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Voornaam</label>
          <input type="text" name="first_name" placeholder="Jan" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Achternaam</label>
          <input type="text" name="last_name" placeholder="Janssen" class="form-input" required>
        </div>
      </div>
      
      <div class="form-group mt-4">
        <label class="form-label">Heeft bijchauffeur?</label>
        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="role" value="driver" checked style="cursor: pointer;">
            <span>Nee</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="role" value="helper" style="cursor: pointer;">
            <span>Ja</span>
          </label>
        </div>
      </div>
      
      <!-- Beschikbaarheidskalender -->
      <div class="form-group mt-4">
        <label class="form-label">Beschikbaarheidsdatums</label>
        <div class="card availability-calendar-card" style="margin-top: 0.5rem;">
          <div class="card-body">
            <div class="availability-calendar-grid">
              <!-- Maand 1 -->
              <div>
                <h4 id="month1-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
                <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
                </div>
                <div id="month1-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
              </div>
              
              <!-- Maand 2 -->
              <div>
                <h4 id="month2-label" class="font-medium text-center mb-3" style="color: var(--color-navy);"></h4>
                <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px;">
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Ma</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Di</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Wo</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Do</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Vr</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Za</div>
                  <div class="text-center text-xs font-medium text-muted" style="padding: 6px 0;">Zo</div>
                </div>
                <div id="month2-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;"></div>
              </div>
            </div>
            
            <p id="calendar-hint" class="text-xs text-muted mt-4" style="text-align: center;">
              Klik op dagen om ze te selecteren als beschikbaarheidsdatums. Geselecteerde dagen worden groen weergegeven.
            </p>
            
            <!-- Hidden input voor geselecteerde datums -->
            <input type="hidden" id="selected-dates-input" name="availability_dates" value="">
          </div>
        </div>
      </div>
      
      <div class="mt-4">
        <button type="submit" class="btn btn-primary">Bezorger toevoegen</button>
      </div>
    </form>
  </div>
</div>

<div class="divider"></div>

<!-- Overzicht Bezorgers -->
<div class="table-container">
  <div class="card-header flex justify-between items-center">
    <div>
      <h2 class="font-semibold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
        </svg>
        Overzicht Bezorgers
      </h2>
    </div>
  </div>

  {% if drivers %}
    <table class="table">
      <thead>
        <tr>
          <th>Naam</th>
          <th>E-mailadres</th>
          <th>Beschikbaarheid</th>
          <th class="text-center actions-col"></th>
        </tr>
      </thead>
      <tbody>
        {% for driver in drivers %}
          <tr>
            <td class="name-col">
              <span class="font-medium">{{ driver.name or (driver.first_name + ' ' + driver.last_name) }}</span>
              {% set role_val = driver.role.value if driver.role is defined and driver.role is not string else driver.role %}
              <div class="role-badge-wrap">
                {% if role_val == 'helper' %}
                  <span class="badge badge-default role-badge">Helper</span>
                {% else %}
                  <span class="badge badge-default role-badge">Chauffeur</span>
                {% endif %}
              </div>
            </td>
            <td>{{ driver.email or '—' }}</td>
            <td>
              {% if driver.available_dates and driver.available_dates|length > 0 %}
                {% if driver.available_today %}
                  <span class="badge badge-success">Beschikbaar vandaag</span>
                  {% if driver.available_dates|length > 1 %}
                    <br><span class="text-muted" style="display: block; margin-top: 4px; font-size: 0.875rem;">
                      Ook: {{ driver.available_dates|join(', ') }}
                    </span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">{{ driver.available_dates|join(', ') }}</span>
                {% endif %}
              {% else %}
                <span class="text-muted">Geen beschikbaarheid</span>
              {% endif %}
            </td>
            <td class="text-center">
              <form method="POST" action="{{ url_for('main.delete_driver', employee_id=driver.employee_id) }}" style="display: inline;" onsubmit="return confirm('Weet je zeker dat je deze chauffeur wilt verwijderen?');">
                <button type="submit" class="btn btn-danger btn-sm">Verwijderen</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Mobile card view -->
    <div class="table-mobile-view" style="display: none;">
      {% for driver in drivers %}
        <div class="table-mobile-card">
          <div class="table-mobile-row">
            <div class="table-mobile-label">Naam</div>
            <div class="table-mobile-value font-medium">
              {{ driver.name or (driver.first_name + ' ' + driver.last_name) }}
              {% if driver.role == 'helper' or (driver.role and driver.role.value == 'helper') %}
                <span class="badge badge-default" style="margin-left: 6px;">Helper</span>
              {% else %}
                <span class="badge badge-default" style="margin-left: 6px;">Chauffeur</span>
              {% endif %}
            </div>
          </div>
          <div class="table-mobile-row">
            <div class="table-mobile-label">E-mailadres</div>
            <div class="table-mobile-value">
              {{ driver.email or '—' }}
            </div>
          </div>
          <div class="table-mobile-row">
            <div class="table-mobile-label">Beschikbaarheid</div>
            <div class="table-mobile-value">
              {% if driver.available_dates and driver.available_dates|length > 0 %}
                {% if driver.available_today %}
                  <span class="badge badge-success">Beschikbaar vandaag</span>
                  {% if driver.available_dates|length > 1 %}
                    <span class="text-muted" style="display:block; margin-top:4px; font-size:0.875rem;">
                      Ook: {{ driver.available_dates|join(', ') }}
                    </span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">{{ driver.available_dates|join(', ') }}</span>
                {% endif %}
              {% else %}
                <span class="text-muted">Geen beschikbaarheid</span>
              {% endif %}
            </div>
          </div>
          <div class="table-mobile-row delete-row">
            <form method="POST" action="{{ url_for('main.delete_driver', employee_id=driver.employee_id) }}" style="display: inline; width:100%;" onsubmit="return confirm('Weet je zeker dat je deze chauffeur wilt verwijderen?');">
              <button type="submit" class="btn btn-danger mobile-delete-btn">Verwijderen</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="card-footer">
      {% set total_drivers = drivers | selectattr('role', 'equalto', 'driver') | list | length + (drivers | selectattr('role', 'equalto', EmployeeRole.driver) | list | length if EmployeeRole is defined else 0) %}
      {% set total_helpers = drivers | selectattr('role', 'equalto', 'helper') | list | length + (drivers | selectattr('role', 'equalto', EmployeeRole.helper) | list | length if EmployeeRole is defined else 0) %}
      <p class="text-small text-muted">
        Totaal: <strong>{{ total_drivers + total_helpers }}</strong> bezorgers
        — chauffeurs: <strong>{{ total_drivers }}</strong>, helpers: <strong>{{ total_helpers }}</strong>
      </p>
    </div>
  {% else %}
    <div class="empty-state">
      <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
      </svg>
      <p class="empty-state-title">Er zijn nog geen chauffeurs geregistreerd.</p>
      <p class="empty-state-text">Voeg een chauffeur toe via het formulier hierboven.</p>
    </div>
  {% endif %}
</div>

<script>
  // Show mobile view on mobile devices (match geplande leveringen gedrag)
  if (window.innerWidth <= 768) {
    const tableContainers = document.querySelectorAll('.table-container');
    tableContainers.forEach(container => {
      const table = container.querySelector('.table');
      const mobileView = container.querySelector('.table-mobile-view');
      if (table && mobileView) {
        table.style.display = 'none';
        mobileView.style.display = 'block';
      }
    });
  }
</script>

<style>
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    background: rgba(0, 0, 0, 0.03);
    color: var(--color-dark-gray);
  }
  
  .calendar-day:hover:not(.disabled):not(.empty):not(.past) {
    transform: scale(1.08);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }
  
  .calendar-day.empty {
    background: transparent;
    cursor: default;
  }
  
  .calendar-day.past {
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.25);
    cursor: not-allowed;
  }
  
  /* Groen - Beschikbaar / Selecteerbaar */
  .calendar-day.available {
    background: rgba(16, 185, 129, 0.15);
    color: #065F46;
    font-weight: 500;
  }
  
  .calendar-day.available:hover {
    background: #10B981;
    color: white;
  }
  
  .calendar-day.today {
    border: 2px solid var(--color-navy);
    font-weight: 600;
  }
  
  /* Geselecteerde dag - Donkerder Groen */
  .calendar-day.selected {
    background: #10B981 !important;
    color: white !important;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  
  .calendar-day.selected:hover {
    background: #059669 !important;
  }

  /* Responsive grid similar to Nieuwe Levering planner */
  .availability-calendar-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .availability-calendar-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
    }

    .availability-calendar-card .card-body {
      padding: var(--spacing-md);
    }
  }
</style>

<script>
  let selectedDates = new Set(); // Set voor unieke datums
  const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 
                      'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];

  document.addEventListener('DOMContentLoaded', function() {
    renderCalendar();
  });

  function renderCalendar() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Maand 1: huidige maand
    const month1 = today.getMonth();
    const year1 = today.getFullYear();
    
    // Maand 2: volgende maand
    let month2 = month1 + 1;
    let year2 = year1;
    if (month2 > 11) {
      month2 = 0;
      year2++;
    }
    
    // Render beide maanden
    renderMonth('month1', month1, year1, today);
    renderMonth('month2', month2, year2, today);
    
    updateSelectedDatesInput();
  }

  // Helper function to format date as YYYY-MM-DD without timezone conversion
  function formatDateString(year, month, day) {
    const m = String(month + 1).padStart(2, '0');
    const d = String(day).padStart(2, '0');
    return `${year}-${m}-${d}`;
  }

  function renderMonth(containerId, month, year, today) {
    // Set label
    document.getElementById(`${containerId}-label`).textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Get the day of week for the first day (0 = Sunday, we want Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6; // Sunday becomes 6
    
    const daysContainer = document.getElementById(`${containerId}-days`);
    daysContainer.innerHTML = '';
    
    // Empty cells before the first day
    for (let i = 0; i < startDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      daysContainer.appendChild(emptyCell);
    }
    
    // Days of the month
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateObj = new Date(year, month, day);
      const dateStr = formatDateString(year, month, day);
      const isPast = dateObj < today;
      const isToday = dateObj.getTime() === today.getTime();
      const isSelected = selectedDates.has(dateStr);
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      dayCell.textContent = day;
      dayCell.dataset.date = dateStr;
      
      if (isPast) {
        dayCell.classList.add('past');
      } else {
        dayCell.classList.add('available');
        dayCell.onclick = () => toggleDate(dateStr);
      }
      
      if (isToday) {
        dayCell.classList.add('today');
      }
      
      if (isSelected) {
        dayCell.classList.add('selected');
      }
      
      daysContainer.appendChild(dayCell);
    }
  }

  function toggleDate(dateStr) {
    if (selectedDates.has(dateStr)) {
      selectedDates.delete(dateStr);
    } else {
      selectedDates.add(dateStr);
    }
    renderCalendar(); // Re-render om selectie te updaten
    updateSelectedDatesInput();
  }

  function updateSelectedDatesInput() {
    // Update hidden input met alle geselecteerde datums (comma-separated)
    const sortedDates = Array.from(selectedDates).sort();
    document.getElementById('selected-dates-input').value = sortedDates.join(',');
  }
</script>
{% endblock %}
